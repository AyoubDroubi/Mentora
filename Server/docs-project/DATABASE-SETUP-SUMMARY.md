# ?? ???? ????? ????? ???????? ???????

## ? ??????? ???????: ????

?? ????? ?????? ????? ?????? ????? Mentora ???? ???? ?????!

---

## ?? ??????? ???? ?? ????

### 1. ????? ??????? ?? Entity Framework Tools
**???????**: ???? ???? `dotnet-ef` 10.0.1 ??? ??????? ?? .NET 9
```
System.Runtime, Version=10.0.0.0 not found
```

**????**: 
```bash
dotnet tool uninstall --global dotnet-ef
dotnet tool install --global dotnet-ef --version 9.0.0
```

---

### 2. ????? ????? ???????? ???????
**???????**: ??? ????? ????? ???????? ?? ????????

#### `UserAchievement.cs`
- **???**: `public int AchievementId`
- **????**: `public Guid AchievementId` ?

#### `UserSkill.cs`
- **???**: 
  ```csharp
  public Guid Id { get; set; } = Guid.NewGuid(); // Duplicate!
  public int SkillId { get; set; }
  ```
- **????**:
  ```csharp
  public Guid SkillId { get; set; } ?
  ```

---

### 3. ????? Cascade Delete Conflicts
**???????**: SQL Server ?? ???? ?? multiple cascade paths
```
FK_StudyTasks_CareerSteps may cause cycles or multiple cascade paths
```

**????**: ?? `ApplicationDbContext.cs`
```csharp
// ???
.OnDelete(DeleteBehavior.SetNull);

// ????
.OnDelete(DeleteBehavior.NoAction); ?
```

---

## ?? ????? ????? ???????? ????????

### ??????? ??????? (25 ????)

#### ?? Authentication Module
- `AspNetUsers` - ?????????? (?? Identity)
- `AspNetRoles` - ???????
- `AspNetUserRoles` - ??? ?????????? ????????
- `RefreshTokens` - ???? ??????? ????????
- `PasswordResetTokens` - ???? ??????? ???? ??????

#### ?? User Profile & Stats
- `UserProfiles` - ????? ????? ??????????
- `UserStats` - ?????????? ??????? (XP, Level, Streak)
- `UserSkills` - ?????? ????????
- `Skills` - ???????? ??????

#### ?? Career Builder Module
- `CareerPlans` - ??? ?????? ??????
- `CareerSteps` - ????? ?????
- `CareerPlanSkills` - ???????? ????????
- `StepCheckpoints` - ???? ?????? ????????
- `LearningResources` - ??????? ?????????

#### ?? Study Scheduler Module
- `StudyPlans` - ??? ???????
- `AvailabilitySlots` - ??????? ???????
- `StudyTasks` - ?????? ????????
- `StudySessions` - ????? ???????
- `TaskFeedbackLogs` - ??? ??????? ???????

#### ?? Engagement & Tracking
- `Achievements` - ????????? ??????
- `UserAchievements` - ??????? ????????
- `DailyReflections` - ???????? ???????
- `Notifications` - ?????????
- `AiRequestLogs` - ??? ????? ?????? ?????????
- `UserDiagnosticResponses` - ?????? ??????? ??????

---

## ?? ????? ApplicationDbContext

### ??????? ???????:

1. **GUID Primary Keys** ?
   - ???? ??????? ?????? `Guid` ?????? ?????

2. **Soft Delete** ?
   - ????? ?? ??? ????? `IsDeleted = true` ????????? ?? ??????? ???????
   - Query Filter ?????? ??????? ???????? ????????

3. **Auto Timestamps** ?
   ```csharp
   CreatedAt - ????? ???????? ??? ???????
   UpdatedAt - ????? ???????? ??? ???????
   DeletedAt - ????? ???????? ??? ?????
   ```

4. **Enum to String Conversion** ?
   ```csharp
   - StudyTask.Status ? string
   - StudyTask.Priority ? string
   - CareerStep.Status ? string
   - UserSkill.CurrentLevel ? string
   - CareerPlanSkill.TargetLevel ? string
   ```

---

## ?? Background Services

### TokenCleanupService
**???????**: ????? ?????? ???????? ????????

**??????**: ?? 24 ????

**?? ??? ????**:
1. `PasswordResetToken` ???????? ?? ????????? ??? ???? ?? 7 ????
2. `RefreshToken` ???????? ?? ??????? ??? ???? ?? 7 ????

**???????**: 
```csharp
builder.Services.AddHostedService<TokenCleanupService>();
```

---

## ?? ????? ???????

### 1. ?????? ?? ????? ????? ???????
```json
// appsettings.json
"ConnectionStrings": {
  "DefaultConnection": "Server=.;Database=MentoraDb;User ID=sa;Password=YOUR_PASSWORD;MultipleActiveResultSets=True;Encrypt=False"
}
```

### 2. ?????? ?? ???? Migration
```bash
cd Server/src/Mentora.Infrastructure
dotnet ef migrations list --startup-project ../Mentora.Api
```

**??????? ????????**:
```
? 20251231070541_InitialMigration
```

### 3. ????? ????? ????????
```bash
dotnet ef database update --startup-project ../Mentora.Api
```

**??????? ????????**: `Done.`

### 4. ????? ???????
```bash
cd ../Mentora.Api
dotnet run
```

**??????? ????????**:
```
? Token Cleanup Service started
? Now listening on: https://localhost:7xxx
? Swagger UI: https://localhost:7xxx/swagger
```

---

## ? Checklist ????????

### ????? ????????
- [?] Migration ?? ??????? ?????
- [?] ????? ???????? ?? ??????? ????? (MentoraDb)
- [?] ???? ??????? (25 ????) ?????
- [?] ???? ???????? (Foreign Keys) ?????
- [?] ???? ????? Indexes ?????

### ApplicationDbContext
- [?] DbSet ????? ???????? ????
- [?] Relationships ??????? ???? ????
- [?] Soft Delete Query Filter ??????
- [?] Auto Timestamps ???????
- [?] Enum Conversions ???????

### Background Services
- [?] TokenCleanupService ??????
- [?] IServiceProvider Scoping ????
- [?] Logging ??????

### Build & Compilation
- [?] ??????? ???? ?????
- [?] ?? ???? ????? ????
- [?] ?? ???? ??????? ????

---

## ?? ??????? ????

### 1. Soft Delete Behavior
??? ??? ?? ????:
```csharp
// ????? ??
context.Users.Remove(user);

// ??? ??????
entity.IsDeleted = true;
entity.DeletedAt = DateTime.UtcNow;
```

### 2. Token Cleanup
- ???? ???????? ?? 24 ????
- ???? ????? ?????? ?? `TokenCleanupService.cs`:
  ```csharp
  private readonly TimeSpan _cleanupInterval = TimeSpan.FromHours(24);
  ```

### 3. Cascade Delete Strategy
- User ? CareerPlans: **Cascade** (??? ???????? ???? ????)
- User ? RefreshTokens: **Cascade** (??? ???????? ???? ?????)
- User ? UserProfile: **Cascade** (??? ???????? ???? ????)
- StudyTask ? CareerStep: **NoAction** (???? cascade conflicts)

---

## ?? ????? ????? ??????

### 1. ??? ??????? ?? SQL Server
```sql
USE MentoraDb;
SELECT TABLE_NAME 
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_TYPE = 'BASE TABLE'
ORDER BY TABLE_NAME;
```

### 2. ??? ??? ???????
```sql
SELECT 
    t.NAME AS TableName,
    p.rows AS RowCounts
FROM sys.tables t
INNER JOIN sys.partitions p ON t.object_id = p.OBJECT_ID
WHERE p.index_id < 2
ORDER BY t.NAME;
```

### 3. ??? ???? Foreign Keys
```sql
SELECT 
    fk.name AS ForeignKey,
    OBJECT_NAME(fk.parent_object_id) AS TableName,
    COL_NAME(fc.parent_object_id, fc.parent_column_id) AS ColumnName,
    OBJECT_NAME(fk.referenced_object_id) AS ReferencedTable
FROM sys.foreign_keys AS fk
INNER JOIN sys.foreign_key_columns AS fc 
    ON fk.object_id = fc.constraint_object_id
ORDER BY TableName;
```

---

## ?? ???????

? **????? ???????? ????? ????? ????**
- ????? ???????? ????? ??????
- ApplicationDbContext ???? ???? ????
- Background Services ???? ?????
- ??????? ???? ?????

**??? ?????**: 31 ?????? 2024  
**??????**: ? ???? ???????
